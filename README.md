# Gozon Shop - Microservices Architecture
## Автор
Солод Алексей Александрович БПИ-248

## Описание проекта
Система представляет собой интернет-магазин, построенный на микросервисной архитектуре. Проект реализует асинхронное взаимодействие между сервисами с гарантией доставки сообщений и идемпотентностью обработки платежей.

## Стек технологий
* **Язык:** Python 3.10
* **Фреймворк:** FastAPI
* **База данных:** PostgreSQL (отдельная схема для каждого сервиса, shared instance)
* **Брокер сообщений:** RabbitMQ
* **Контейнеризация:** Docker, Docker Compose
* **Frontend:** HTML5, Vanilla JS, Nginx

## Архитектура и Реализация паттернов

Система состоит из трех основных компонентов:

### 1. API Gateway
Единая точка входа. Проксирует HTTP-запросы от фронтенда к соответствующим микросервисам (Orders Service и Payments Service), скрывая внутреннюю топологию сети.

### 2. Orders Service (Сервис заказов)
Отвечает за создание заказов.
* **Паттерн Transactional Outbox:** При создании заказа данные сохраняются в таблицу `orders` и событие в таблицу `outbox` в рамках одной атомарной транзакции БД. Это гарантирует, что событие не потеряется, даже если брокер сообщений недоступен.
* **Фоновый процесс:** Отдельный поток читает события из `outbox` и публикует их в очередь RabbitMQ (`orders_queue`).

### 3. Payments Service (Сервис платежей)
Отвечает за ведение счетов пользователей и транзакции.
* **Idempotent Consumer (Inbox Pattern):** При получении сообщения сервис проверяет таблицу `inbox` на наличие `message_id`. Если сообщение уже обработано, оно игнорируется. Это обеспечивает семантику **exactly-once** (ровно одна обработка) при доставке **at-least-once** (хотя бы одна доставка).
* **Atomic Updates:** Списание средств происходит с использованием блокировки `SELECT ... FOR UPDATE` или атомарных операций БД для предотвращения состояния гонки (Race Condition) при параллельных запросах.
* **Результат обработки:** После попытки оплаты сервис публикует событие успеха или неудачи обратно в очередь.

## Структура проекта

gozon_shop/
├── docker-compose.yml  # Инфраструктура (БД, Брокер, Сервисы)
├── gateway/            # API Gateway (FastAPI)
├── orders/             # Сервис заказов (FastAPI + Outbox)
├── payments/           # Сервис платежей (FastAPI + Inbox + Idempotency)
└── frontend/           # Статический веб-интерфейс (Nginx)

## Инструкция по запуску
Сборка и запуск контейнеров: docker compose up -d --build
Доступ к приложению: http://localhost

## Описание API

Работа со счетами (Payments Service)
POST /accounts/

Создание счета или пополнение баланса.

Body: {"user_id": 1, "balance": 1000}

GET /accounts/{user_id}

Получение текущего баланса.

Работа с заказами (Orders Service)
POST /orders/

Создание заказа. Запускает асинхронный процесс списания средств.


Body: {"user_id": 1, "item": "Laptop", "price": 1000}
